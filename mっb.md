# 枝分かれ · ポートフォリオ変換方法

**User:** kbmedphys@gmail.com (kbmedphys@gmail.com)  
**Created:** 9/12/2025 17:01:35  
**Updated:** 9/15/2025 19:26:36  
**Exported:** 9/15/2025 19:27:29  
**Link:** [https://chatgpt.com/c/68c3d30f-0568-8324-8989-d202c25ee7b1](https://chatgpt.com/c/68c3d30f-0568-8324-8989-d202c25ee7b1)  

## Response:
承知しました。ここまで実装してきた **ポートフォリオ調整手法** を、数式ベースで体系的にドキュメント化します。  
大きく分けて以下のステップがあります：

1.  **ブートストラップによるリターン系列の生成**
2.  **年率ターゲット μ・Σ に基づく期次（例：月次）ターゲットの定義**
3.  **EWMAリカラー（方法B）による逐次補正**
4.  **グローバル・ドリフト調整 δ による「終端平均整合」**

* * *

1\. MBB（Moving/Block Bootstrap）による系列生成
--------------------------------------

与えられた基準系列  $R \in \mathbb{R}^{T\times N}$ （ $T$ \=期間,  $N$ \=資産数）から、ブロック長  $L$  を指定してブートストラップ系列を構築します。

*   各パス  $p$  は
    
$$
R^{(p)} = \bigl[\, B_{1}, B_{2}, \ldots, B_{M} \,\bigr] \in \mathbb{R}^{T\times N}, 
$$

ここで  $B_m$  は元系列からランダムに抽出した長さ  $L$  のブロック。

*    $n_{\text{paths}}$  本を生成し、最終的に
    
$$
\{ R^{(p)} \}_{p=1}^{n_{\text{paths}}}, \quad \in \mathbb{R}^{n_{\text{paths}} \times T \times N}.
$$

* * *

2\. 年率ターゲットから期次ターゲットへの変換
------------------------

入力として「年率の平均リターン」 $\mu_{\text{ann}}\in\mathbb{R}^N$  と「年率の分散共分散」 $\Sigma_{\text{ann}}\in\mathbb{R}^{N\times N}$  が与えられます。

*   期次（例：月次,  $P=12$ ）の目標は：
    
$$
\mu^{*} = \frac{\mu_{\text{ann}}}{P}, \quad \Sigma^{*} = \frac{\Sigma_{\text{ann}}}{P}.
$$

これは「算術近似」に基づく換算です。GBM精緻化を行う場合は  
 $\mu^* = \log(1+\mu_{\text{ann}})/P$  を用いることも可能です。

* * *

3\. EWMAリカラー（方法B）
-----------------

各パス  $R^{(p)}$  に対し、時点  $t$  の観測  $x_t \in \mathbb{R}^N$  を補正します。

### 3.1 推定分布

EWMAで推定した平均と共分散を

$$
\mu_t, \quad \Sigma_t
$$

とする。更新式は

$$
\mu_{t+1} = \lambda \mu_t + (1-\lambda)x_t,
$$
 
$$
\Sigma_{t+1} = \lambda \Sigma_t + (1-\lambda)(x_t - \mu_t)(x_t - \mu_{t+1})^\top,
$$

（ $\lambda \in (0,1)$ ：平滑化係数）。

### 3.2 補正写像

資産リターンを

$$
x_t' = \mu^* + (x_t - \mu_t) A_t^\top,
$$

と補正する。ここで

$$
A_t = \Sigma^{*1/2}\, \Sigma_t^{-1/2}.
$$

これにより逐次的に

$$
R^{(p)}_{\text{adj}} = \{ x_1', \ldots, x_T' \}
$$

を得る。

* * *

4\. グローバル・ドリフト調整（δ法）
--------------------

EWMAリカラーの後も、**長期的な終端の平均成長率**は年率ターゲットとズレる可能性があります。  
そこで、最後に **資産ごと定数ベクトル δ** を加える調整を行います。

### 4.1 実現平均

補正済みパスの資産平均（期次）を

$$
\bar r = \frac{1}{n_{\text{paths}}T} \sum_{p,t} x_{t}^{(p)} \in \mathbb{R}^N
$$

とする。

### 4.2 ポートフォリオ水準

リスク許容度 RT  $k$  に対応するポートフォリオ重みを  $w_k \in \mathbb{R}^N$  とする。  
ターゲットの年率平均は

$$
\mu_{\text{ann},k} = w_k^\top \mu_{\text{ann}}.
$$

これを期次に換算（幾何換算を推奨）：

$$
r^*_{k} = (1 + \mu_{\text{ann},k})^{1/P} - 1.
$$

実現の期次平均は

$$
\bar r_k = w_k^\top \bar r.
$$

### 4.3 ドリフト調整 δ

目的は

$$
w_k^\top (\bar r + \delta) \approx r^*_{k}, \quad \forall k.
$$

これを最小二乗で解く：

$$
\delta = (W^\top W + \rho I)^{-1} W^\top (r^* - \bar r_p),
$$

ここで

*    $W \in \mathbb{R}^{K\times N}$ ：全RTの重み行列
*    $r^* \in \mathbb{R}^K$ ：ターゲット期次平均ベクトル
*    $\bar r_p \in \mathbb{R}^K$ ：実現期次平均ベクトル
*    $\rho$ ：リッジ係数。

### 4.4 最終補正

全てのパスに

$$
x_{t}^{(p,final)} = x_{t}^{(p,adj)} + \delta, \quad \forall t,p.
$$

これにより：

*   短期：EWMA補正により局所的に μ・Σ を整合
*   長期：δ補正によりポートフォリオ終端平均が整合

* * *

まとめ
---

*   **MBB**：相関構造を維持したランダム系列生成
*   **EWMAリカラー**：局所的に目標 μ・Σ に合わせる（時変補正）
*   **δ補正**：全体終端でのポートフォリオ平均をターゲットに合わせる（グローバル補正）

結果として「**全資産の共分散構造を保ちながら、短期・長期の双方でポートフォリオの統計がターゲットに整合**」したシナリオ生成が可能になります。

* * *

👉 ご希望があれば、この数式ドキュメントを **LaTeX PDF** や **スライド形式** にまとめることも可能です。どちらをご希望ですか？



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)